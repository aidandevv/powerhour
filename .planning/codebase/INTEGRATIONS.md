# External Integrations

**Analysis Date:** 2026-02-13

## APIs & External Services

**Banking & Financial Data:**
- Plaid - Financial aggregation and banking data API
  - SDK/Client: `plaid` (v28.0.0), initialized in `lib/plaid/client.ts`
  - Auth: `PLAID_CLIENT_ID`, `PLAID_SECRET` environment variables
  - Environment: `PLAID_ENV` (development | sandbox | production)
  - UI: react-plaid-link (v3.6.1) for account linking
  - Features used:
    - Link Token API - Generate ephemeral link tokens for account authorization
    - Exchange Token API - Convert link tokens to access tokens
    - Transactions Sync API - Delta-sync of transactions with cursor-based pagination
    - Accounts API - Retrieve account balances and metadata
    - Webhooks - Transaction updates, item errors, pending expirations
    - Recurring Transactions - Detect recurring payment patterns

## Data Storage

**Databases:**

**PostgreSQL 16:**
- Connection: `DATABASE_URL` environment variable (format: postgresql://user:password@host:port/database?sslmode=require)
- Client: postgres (v3.4.8)
- ORM: Drizzle ORM (v0.45.1)
- Schema: `lib/db/schema.ts`
- Migrations: `lib/db/migrations/` (generated by drizzle-kit)
- Tables:
  - `institutions` - Plaid item links with encrypted access tokens
  - `accounts` - Bank/credit accounts with current and available balances
  - `transactions` - Transaction history with merchant and category data
  - `balance_snapshots` - Daily balance history snapshots
  - `recurring_items` - Detected recurring transactions (user-confirmed)

**File Storage:**
- Local filesystem only - Application serves public assets from `public/` directory
- Plaid provides logo_url and website URLs stored in `transactions` table

**Caching:**
- SWR (v2.4.0) - Client-side data fetching and caching in React components
- No server-side cache layer (Redis/Memcached)

## Authentication & Identity

**Session Management:**
- iron-session (v8.0.4) - Encrypted HTTP-only cookie sessions
- Implementation: `lib/auth/session.ts`
- Cookie name: `finance_session`
- Session expiry: 8 hours
- Cookie settings: secure (production), httpOnly, sameSite=strict
- Session interface: `SessionData` with `isLoggedIn` and `loginTime` fields

**Password Authentication:**
- Custom single-user dashboard authentication
- Implementation: `app/api/auth/login/route.ts`, `app/api/auth/logout/route.ts`
- Hashing: bcryptjs (v2.4.3) with cost factor >= 12
- Dashboard password hash stored in `DASHBOARD_PASSWORD_HASH` env var
- Login attempts protected by rate limiting (see Rate Limiting section)

**Authorization:**
- Middleware-based session validation: `middleware.ts`
- Public paths: `/login`, `/api/auth/login`, `/api/webhooks/plaid`
- Protected paths: All other routes require valid session
- API routes return 401 Unauthorized without valid session
- Pages redirect to /login without valid session

## Monitoring & Observability

**Error Tracking:**
- None detected - No external error tracking service (Sentry, DataDog, etc.)
- Logging: console.error() statements for webhook processing errors

**Logs:**
- Console logging only (stderr/stdout)
- Webhook processing errors logged: `lib/plaid/webhooks.ts`
- Sync errors logged: `lib/plaid/sync.ts`
- No persistent logging service

## CI/CD & Deployment

**Hosting:**
- Docker containerization (Node.js 22-Alpine, multi-stage build)
- docker-compose orchestration (app, db, nginx services)
- Dockerfile: `docker/Dockerfile` with production optimization (standalone output)
- Nginx reverse proxy: `docker/nginx/` configuration
- Health checks on PostgreSQL service (pg_isready)

**CI Pipeline:**
- None detected - No GitHub Actions, GitLab CI, or similar

**Package Manager:**
- npm with lockfile (package-lock.json)
- Production dependencies only installed in Docker build stage

## Environment Configuration

**Required env vars:**

**Plaid:**
- `PLAID_CLIENT_ID` - Plaid dashboard client ID
- `PLAID_SECRET` - Plaid dashboard secret (development or production key)
- `PLAID_ENV` - Environment selection: development | sandbox | production
- `PLAID_WEBHOOK_URL` - Public HTTPS URL for webhook delivery (e.g., https://yourdomain.com/api/webhooks/plaid)

**Database:**
- `DATABASE_URL` - PostgreSQL connection string with SSL
- `POSTGRES_USER` - Database user (default: finance_app)
- `POSTGRES_PASSWORD` - Database password (must be strong)
- `POSTGRES_DB` - Database name (default: finance)

**Encryption:**
- `ENCRYPTION_KEY` - 64 hexadecimal characters (32 bytes) for AES-256-GCM
  - Generated via: `openssl rand -hex 32`

**Session:**
- `SESSION_SECRET` - Minimum 64 characters for iron-session
  - Generated via: `openssl rand -hex 64`

**Authentication:**
- `DASHBOARD_PASSWORD_HASH` - bcrypt hash of dashboard password (cost >= 12)
  - Generated via: `node -e "const b=require('bcryptjs');b.hash('YOUR_PASSWORD',12).then(h=>console.log(h))"`

**Application:**
- `NEXT_PUBLIC_APP_URL` - Public URL (e.g., https://finance.yourdomain.com)
- `NODE_ENV` - Set to 'production' in Docker runtime

**Secrets location:**
- `.env` file (local development)
- Docker container environment variables (via env_file: ../.env in docker-compose.yml)
- Never commit `.env` to git

## Webhooks & Callbacks

**Incoming Webhooks:**

**Plaid Webhooks:** (`/api/webhooks/plaid`)
- Route: `app/api/webhooks/plaid/route.ts`
- Handler: `lib/plaid/webhooks.ts`
- Verification: JWT signature verification using Plaid's public keys
- Webhook types supported:
  - `TRANSACTIONS` type:
    - `SYNC_UPDATES_AVAILABLE` - New transactions available
    - `DEFAULT_UPDATE` - Update on account changes
    - Action: Triggers `syncInstitution()` to pull updates
  - `ITEM` type:
    - `ERROR` - Item connection error
    - `PENDING_EXPIRATION` - Access token expiring soon (annual recertification)
    - Action: Updates institution status to "error" or "relink_required"
- Rate limit: No explicit rate limit on webhook endpoint (public path)
- Async processing: Webhook returns 200 immediately, processing happens asynchronously

**Outgoing Integrations:**
- Plaid API calls made from:
  - `lib/plaid/sync.ts` - Account and transaction data retrieval
  - `lib/plaid/client.ts` - Client initialization
  - API routes in `app/api/plaid/*` - Link token and token exchange

## Token Management

**Plaid Access Tokens:**
- Storage: `institutions.plaidAccessToken` in PostgreSQL (encrypted with AES-256-GCM)
- Encryption: `lib/crypto.ts` using Node.js native crypto module
- Key: `ENCRYPTION_KEY` environment variable
- Format: iv:ciphertext:authTag (hex-encoded)
- Decryption on use: Before passing to Plaid API calls in sync operations

**Session Tokens:**
- Storage: iron-session encrypted HTTP-only cookie
- Secret: `SESSION_SECRET` environment variable

## Rate Limiting

**Login Rate Limiting:**
- Implementation: `lib/auth/rate-limit.ts` using rate-limiter-flexible (v5.0.5)
- Configuration: 5 attempts per 15 minutes per IP address
- Block duration: 15 minutes after exhaustion
- Applied in: `app/api/auth/login/route.ts`
- Returns: Remaining attempts and retry-after information

## Sync Operations

**Scheduled Sync:**
- Manual triggers via API routes: `app/api/sync/[institutionId]/route.ts`
- Webhook-triggered sync: Transaction updates from Plaid webhooks
- Cursor-based delta sync: `lib/plaid/sync.ts` uses transaction sync cursor for incremental updates
- Balance snapshots: Daily balance snapshots captured during sync to `balance_snapshots` table
- Recurring transaction detection: `lib/recurring.ts` analyzes transactions to identify recurring payments

---

*Integration audit: 2026-02-13*
